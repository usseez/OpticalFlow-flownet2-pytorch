# CUDA 12.4, cuDNN, Ubuntu 22.04
FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04
LABEL maintainer="hirakawat"

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update -y && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
      sudo build-essential cmake g++ gfortran pkg-config \
      libhdf5-dev \
      wget curl git htop tmux vim ffmpeg rsync openssh-server \
      python3 python3-dev python3-pip python3-venv && \
    rm -rf /var/lib/apt/lists/*

# CUDA paths (keep these simple; container already sets most)
ENV CUDA_ROOT=/usr/local/cuda
ENV PATH=${PATH}:${CUDA_ROOT}/bin
ENV LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${CUDA_ROOT}/lib64:/usr/local/nvidia/lib64
ENV LIBRARY_PATH=${LIBRARY_PATH}:${CUDA_ROOT}/lib64

# (Optional) create a non-root user; comment out if you prefer root
# RUN useradd -m -s /bin/bash dev && echo "dev ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/dev
# USER dev
# WORKDIR /home/dev

# Python packages
# - Drop the very old pins (e.g., scipy==1.2.0) that break on Python 3.10
# - Install PyTorch matching CUDA 12.1 wheels (closest official match; compatible with driver on CUDA 12.4 images)
#   See: use cu121 index for torch/vision/audio
RUN python3 -m pip install --upgrade pip wheel setuptools && \
    python3 -m pip install --no-cache-dir \
      numpy scipy matplotlib seaborn scikit-learn scikit-image pillow requests \
      jupyterlab networkx h5py pandas plotly protobuf tqdm tensorboardX colorama setproctitle && \
    python3 -m pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cu121 \
      torch torchvision torchaudio

# OpenSSH server minimal setup (optional)
RUN mkdir /var/run/sshd
EXPOSE 22

# Convenience: print versions at build time
RUN python3 - <<'PY'
import torch, sys
print("Python:", sys.version)
print("Torch:", torch.__version__)
print("CUDA available:", torch.cuda.is_available())
print("CUDA version reported by torch:", torch.version.cuda)
print("GPU count:", torch.cuda.device_count())
PY

